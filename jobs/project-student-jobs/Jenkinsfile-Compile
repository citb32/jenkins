node() {
    stage ('Build') {
 
        git url: 'https://github.com/citb32/student-with-api.git'
    
        withMaven(
            maven: 'MAVEN-3.5.0',
            mavenLocalRepo: '.repository') {
            sh "mvn compile"
        }
    }

    stage('CodeAnalysis-Sonar') {
        withMaven(
            maven: 'MAVEN-3.5.0',
            mavenLocalRepo: '.repository') {
            sh "mvn sonar:sonar -Dsonar.projectKey=citb32_student-with-api -Dsonar.organization=citb32 -Dsonar.host.url=https://sonarcloud.io -Dsonar.login=ada098716846b418d876ae60b13bbac59c0bc71a"
        }
    }

    stage('Packaging-WAR') {
        withMaven(
            maven: 'MAVEN-3.5.0',
            mavenLocalRepo: '.repository') {
            sh "mvn package"
        }
    }

    stage('Setup-Test-Infra'){
        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'TERRAFORM-KEYS',
usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY']]) {

        git url: 'https://github.com/citb32/terraform.git'
        sh '''
export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
cd student-proj-test-env
terraform init
terraform apply -auto-approve
'''
        }
    }
}